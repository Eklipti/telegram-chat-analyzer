<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Telegram Chat Report (MSK)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{
    /* –ë–∞–∑–∞ */
    --bg:#FFFFFF;
    --surface:#FAFAFC;
    --surface-2:#F4F5F7;
    --text:#101316;
    --text-muted:#6B7280;
    --border:#E6E8EE;

    /* –ë—Ä–µ–Ω–¥–æ–≤–∞—è —à–∫–∞–ª–∞ */
    --brand-50:#FFF1F5;
    --brand-100:#FFE0EA;
    --brand-200:#FFC1D2;
    --brand-300:#FF9CB9;
    --brand-400:#FF779F;
    --brand-500:#FF4F86; /* –æ—Å–Ω–æ–≤–Ω–æ–π */
    --brand-600:#E83A73;
    --brand-700:#CC2A5F;
    --brand-800:#A61E4B;
    --brand-900:#7A1538;

    /* –°—Ç–∞—Ç—É—Å—ã */
    --success-500:#22C55E;
    --warning-500:#F59E0B;
    --danger-500:#EF4444;

    /* –°–æ—Å—Ç–æ—è–Ω–∏—è */
    --brand-hover:#E83A73;
    --brand-pressed:#CC2A5F;
    --focus-ring:#FF9CB9;

    /* –î–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
    --plot-bg:var(--surface-2);
    --grid-strong:var(--border);
  }

  html,body{
    margin:0; padding:0;
    background:var(--bg); color:var(--text);
    font:14px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }

  header{
    padding:12px 16px;
    border-bottom:1px solid var(--border);
    background:var(--surface);
    position:sticky; top:0; z-index:10;
  }

  h1{ margin:0 0 2px; font-size:18px; color:var(--brand-500); }
  h2{ margin:0 0 8px; font-size:18px; color:var(--brand-500); }

  .wrap{ max-width:1100px; margin:0 auto; padding:20px; }
  .cards{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px; }
  .card{ background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px 16px; }
  .kpi{ font-size:24px; font-weight:700; color:var(--brand-600); }
  .muted{ color:var(--text-muted); font-size:12px; }
  .pct{ font-size:10px; margin-left:4px; color:var(--text-muted); }

  canvas{ width:100%; height:320px; background:var(--surface); border:1px solid var(--border); border-radius:12px; }
  .section{ margin-top:24px; scroll-margin-top: 60px; }

  .tbl{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums; background:var(--surface); border:1px solid var(--border); border-radius:12px; }
  .tbl th, .tbl td{ border-bottom:1px solid var(--border); padding:8px 10px; text-align:left; }
  .tbl th{ color:var(--text-muted); font-weight:600; }

  pre{ white-space:pre-wrap; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px 14px; overflow:auto; }
  details{ background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
  details summary{ cursor:pointer; user-select:none; font-weight:600; }

  .chip{ display:inline-block; padding:2px 8px; border-radius:999px; background:var(--surface); border:1px solid var(--border); color:var(--text); }

  /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ —Ö–µ–¥–µ—Ä–µ */
  html { scroll-behavior: smooth; }
  .nav { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
  .nav a {
    color: var(--brand-600);
    text-decoration: none;
    padding:6px 10px;
    border-radius:8px;
    border:1px solid transparent;
    font-size:13px;
  }
  .nav a:hover   { color: var(--brand-hover);  background: var(--brand-50);  border-color: var(--brand-100); }
  .nav a:active  { color: var(--brand-pressed); }
  .nav a:focus   { outline: 2px solid var(--focus-ring); outline-offset: 2px; }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <h1>–û—Ç—á—ë—Ç –ø–æ —á–∞—Ç—É</h1>
    <div class="muted">–°–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π HTML</div>
    <nav class="nav">
      <a href="#kpi">–û–±–∑–æ—Ä</a>
      <a href="#daily-sec">–ü–æ –¥–Ω—è–º</a>
      <a href="#hourly-sec">–ü–æ —á–∞—Å–∞–º</a>
      <a href="#top-authors">–¢–æ–ø-10</a>
      <a href="#threads">–í–µ—Ç–∫–∏</a>
      <a href="#emoji">–≠–º–æ–¥–∑–∏</a>
      <a href="#rmsgs">–¢–æ–ø —Å–æ–æ–±—â–µ–Ω–∏—è</a>
      <a href="#rusers">–†–µ–∞–∫—Ü–∏–∏ –ø–æ –∞–≤—Ç–æ—Ä–∞–º</a>
      <a href="#media">–ú–µ–¥–∏–∞</a>
      <a href="#polls">–û–ø—Ä–æ—Å—ã</a>
      <a href="#social">–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ</a>
    </nav>
  </div>
</header>

<div class="wrap">
  <div id="kpi" class="cards section"></div>

  <div class="section" id="daily-sec">
    <h2>–î–∏–Ω–∞–º–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –¥–Ω—è–º</h2>
    <canvas id="daily"></canvas>
  </div>

  <div class="section" id="hourly-sec">
    <h2>–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ —á–∞—Å–∞–º</h2>
    <canvas id="hourly"></canvas>
  </div>

  <div class="section" id="top-authors">
    <h2>–¢–æ–ø-10 –∞–≤—Ç–æ—Ä–æ–≤</h2>
    <table class="tbl" id="topAuthors">
      <thead><tr><th>#</th><th>username</th><th>—Å–æ–æ–±—â–µ–Ω–∏–π</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section" id="threads">
    <h2>–î–ª–∏–Ω–∞ –≤–µ—Ç–æ–∫ ‚Äî —Ç–æ–ø-5</h2>
    <table class="tbl" id="tblThreads">
      <thead><tr><th>#</th><th>root_id</th><th>username</th><th>—Å–æ–æ–±—â–µ–Ω–∏–π</th><th>—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th><th>–¥–∞—Ç–∞</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section" id="emoji">
    <h2>–¢–æ–ø —ç–º–æ–¥–∑–∏ ‚Äî —Ç–æ–ø-5</h2>
    <table class="tbl" id="tblEmoji">
      <thead><tr><th>#</th><th>emoji</th><th>–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section" id="rmsgs">
    <h2>–°–∞–º—ã–µ ¬´—Ä–µ–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ¬ª —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî —Ç–æ–ø-3</h2>
    <table class="tbl" id="tblRMsgs">
      <thead><tr><th>#</th><th>username</th><th>—Ä–µ–∞–∫—Ü–∏–π</th><th>–¥–∞—Ç–∞</th><th>—Ñ—Ä–∞–≥–º–µ–Ω—Ç</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section" id="rusers">
    <h2>–ö—Ç–æ —Å–æ–±—Ä–∞–ª –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Ä–µ–∞–∫—Ü–∏–π ‚Äî —Ç–æ–ø-5</h2>
    <table class="tbl" id="tblRUsers">
      <thead><tr><th>#</th><th>username</th><th>—Ä–µ–∞–∫—Ü–∏–π –≤—Å–µ–≥–æ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section" id="media">
    <h2>–î–æ–ª–∏ –ø–æ —Ç–∏–ø–∞–º –º–µ–¥–∏–∞</h2>
    <table class="tbl" id="tblMedia">
      <thead><tr><th>—Ç–∏–ø</th><th>—Å–æ–æ–±—â–µ–Ω–∏–π</th><th>–¥–æ–ª—è</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section" id="polls">
    <h2>–¢–æ–ø —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π –æ–ø—Ä–æ—Å–æ–≤ ‚Äî —Ç–æ–ø-3</h2>
    <table class="tbl" id="tblPolls">
      <thead><tr><th>#</th><th>username</th><th>–æ–ø—Ä–æ—Å–æ–≤</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section" id="social">
    <h2>–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è</h2>
    
    <div style="margin-bottom: 24px;">
      <h3 style="margin: 16px 0 8px; font-size: 16px; color: var(--brand-600);">–ò–Ω–¥–µ–∫—Å —Ü–∏—Ç–∏—Ä—É–µ–º–æ—Å—Ç–∏</h3>
      <div class="muted" style="margin-bottom: 8px;">–ù–∞ —á—å–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—â–µ –≤—Å–µ–≥–æ –æ—Ç–≤–µ—á–∞—é—Ç (—Ç–æ–ø-10)</div>
      <table class="tbl" id="tblQuotability">
        <thead><tr><th>#</th><th>username</th><th>–ø–æ–ª—É—á–µ–Ω–æ –æ—Ç–≤–µ—Ç–æ–≤</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 16px 0 8px; font-size: 16px; color: var(--brand-600);">–ú–∞—Ç—Ä–∏—Ü–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π</h3>
      <div class="muted" style="margin-bottom: 8px;">–ö–æ–≥–æ —á–∞—â–µ –≤—Å–µ–≥–æ —É–ø–æ–º–∏–Ω–∞—é—Ç —á–µ—Ä–µ–∑ @username (—Ç–æ–ø-15)</div>
      <table class="tbl" id="tblMentions">
        <thead><tr><th>#</th><th>username</th><th>—É–ø–æ–º–∏–Ω–∞–Ω–∏–π</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 16px 0 8px; font-size: 16px; color: var(--brand-600);">–ö–∞—Ä—Ç–∞ —Å–∏–º–ø–∞—Ç–∏–π</h3>
      <div class="muted" style="margin-bottom: 8px;">–ö—Ç–æ –∫–æ–º—É —á–∞—â–µ –æ—Ç–≤–µ—á–∞–µ—Ç (—Ç–æ–ø-20 –ø–∞—Ä)</div>
      <table class="tbl" id="tblReplyMatrix">
        <thead><tr><th>#</th><th>–æ—Ç (–∫—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç)</th><th>–∫–æ–º—É (–Ω–∞ —á—å–∏ —Å–æ–æ–±—â–µ–Ω–∏—è)</th><th>–æ—Ç–≤–µ—Ç–æ–≤</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 16px 0 8px; font-size: 16px; color: var(--brand-600);">–õ—é–±–∏—Ç–µ–ª–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö</h3>
      <div class="muted" style="margin-bottom: 8px;">–¢–æ–ø –ø–æ —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ø-10)</div>
      <table class="tbl" id="tblVoiceLovers">
        <thead><tr><th>#</th><th>username</th><th>–≤—Å–µ–≥–æ —á–∞—Å–æ–≤</th><th>–≤—Å–µ–≥–æ —Å–µ–∫—É–Ω–¥</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 16px 0 8px; font-size: 16px; color: var(--brand-600);">–í–Ω–µ—à–Ω–∏–µ —Å—Å—ã–ª–∫–∏</h3>
      <div class="muted" style="margin-bottom: 8px;">–ö–∞–∫–∏–µ –¥–æ–º–µ–Ω—ã —á–∞—â–µ –≤—Å–µ–≥–æ —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è (—Ç–æ–ø-15)</div>
      <table class="tbl" id="tblDomains">
        <thead><tr><th>#</th><th>–¥–æ–º–µ–Ω</th><th>—É–ø–æ–º–∏–Ω–∞–Ω–∏–π</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 16px 0 8px; font-size: 16px; color: var(--brand-600);">–ö—Ä–∏–∫—É–Ω—ã (CAPS LOCK)</h3>
      <div class="muted" style="margin-bottom: 8px;">–ö—Ç–æ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏, –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ø-10)</div>
      <table class="tbl" id="tblCapsScreamers">
        <thead><tr><th>#</th><th>username</th><th>—Å–æ–æ–±—â–µ–Ω–∏–π —Å CAPS</th><th>% –æ—Ç –≤—Å–µ—Ö</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 16px 0 8px; font-size: 16px; color: var(--brand-600);">–û—Ñ–æ—Ä–º–∏—Ç–µ–ª–∏</h3>
      <div class="muted" style="margin-bottom: 8px;">–ö—Ç–æ —á–∞—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–æ–ø-10)</div>
      <table class="tbl" id="tblFormatting">
        <thead><tr><th>#</th><th>username</th><th>–≤—Å–µ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–π</th><th>–¥–µ—Ç–∞–ª–∏</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 16px 0 8px; font-size: 16px; color: var(--brand-600);">–°–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å (MATTR)</h3>
      <div class="muted" style="margin-bottom: 8px;">–õ–µ–∫—Å–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –ø–æ –º–µ—Ç–æ–¥—É MATTR - —Å—Ä–µ–¥–Ω–µ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –≤ —Å–∫–æ–ª—å–∑—è—â–µ–º –æ–∫–Ω–µ 1000 —Å–ª–æ–≤. –° –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π —Å—Ç–æ–ø-—Å–ª–æ–≤ (—Ç–æ–ø-10, –º–∏–Ω–∏–º—É–º 1000 —Å–æ–æ–±—â–µ–Ω–∏–π)</div>
      <table class="tbl" id="tblVocabulary">
        <thead><tr><th>#</th><th>username</th><th>–≤—Å–µ–≥–æ —Å–ª–æ–≤</th><th>—Å–æ–æ–±—â–µ–Ω–∏–π</th><th>MATTR (%)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h2 style="margin: 24px 0 12px; font-size: 18px; color: var(--brand-700);">–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</h2>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 16px 0 8px; font-size: 16px; color: var(--brand-600);">–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ (Ping)</h3>
      <div class="muted" style="margin-bottom: 8px;">–¢–æ–ø-10 —Å–∞–º—ã—Ö –±—ã—Å—Ç—Ä—ã—Ö –ø–æ –º–µ–¥–∏–∞–Ω–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ reply (–º–∏–Ω–∏–º—É–º 1000 —Å–æ–æ–±—â–µ–Ω–∏–π)</div>
      <table class="tbl" id="tblReactionSpeed">
        <thead><tr><th>#</th><th>username</th><th>–º–µ–¥–∏–∞–Ω–∞</th><th>–æ—Ç–≤–µ—Ç–æ–≤</th><th>–≤—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 16px 0 8px; font-size: 16px; color: var(--brand-600);">"–°–æ–≤—ã" –ø—Ä–æ—Ç–∏–≤ "–ñ–∞–≤–æ—Ä–æ–Ω–∫–æ–≤"</h3>
      <div class="muted" style="margin-bottom: 8px;">–ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–º–∏–Ω–∏–º—É–º 1000 —Å–æ–æ–±—â–µ–Ω–∏–π)</div>
      <table class="tbl" id="tblOwlsVsLarks">
        <thead><tr><th>#</th><th>username</th><th>–∫–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–Ω–æ—á—å (1-6—á) %</th><th>–¥–µ–Ω—å (9-17—á) %</th><th>—Å–æ–æ–±—â–µ–Ω–∏–π</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 16px 0 8px; font-size: 16px; color: var(--brand-600);">–ò–Ω–¥–µ–∫—Å "–°–∞–º–æ—Ü–µ–Ω–∑—É—Ä—ã"</h3>
      <div class="muted" style="margin-bottom: 8px;">–ö—Ç–æ —á–∞—â–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Ç–æ–ø-10, –º–∏–Ω–∏–º—É–º 1000 —Å–æ–æ–±—â–µ–Ω–∏–π)</div>
      <table class="tbl" id="tblSelfCensorship">
        <thead><tr><th>#</th><th>username</th><th>–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ</th><th>–≤—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</th><th>% —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–π</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script id="DATA" type="application/json">__DATA_JSON__</script>

<script>
(function(){
  // data —Ç–µ–ø–µ—Ä—å - —ç—Ç–æ "–ø–ª–æ—Å–∫–∏–π" –æ–±—ä–µ–∫—Ç
  const data = JSON.parse(document.getElementById('DATA').textContent);
  
  // –î–æ—Å—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ "–ø–ª–æ—Å–∫–æ–π" —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
  const summary = data.summary || {
    total_messages:0, 
    replies:{count:0, pct:0}, 
    edited_msgs:0, 
    messages_with_reactions:{count:0, pct:0},
    media:{count:0, pct:0}
  };
  const daily = data.by_day || {};
  const hourly = data.by_hour || {};
  const top = data.top_authors || [];
  
  const total = Number(summary.total_messages || 0);
  const replies = typeof summary.replies === 'object' && summary.replies !== null 
    ? Number(summary.replies.count || 0) 
    : Number(summary.replies || 0);
  const repliesPct = typeof summary.replies === 'object' && summary.replies !== null
    ? Number(summary.replies.pct || 0).toFixed(2)
    : (total ? (replies/total*100).toFixed(2) : "0.00");
  const edited  = Number(summary.edited_msgs || 0);
  const react = typeof summary.messages_with_reactions === 'object' && summary.messages_with_reactions !== null
    ? Number(summary.messages_with_reactions.count || 0)
    : Number(summary.messages_with_reactions || 0);
  const reactPct = typeof summary.messages_with_reactions === 'object' && summary.messages_with_reactions !== null
    ? Number(summary.messages_with_reactions.pct || 0).toFixed(2)
    : (total ? (react/total*100).toFixed(2) : "0.00");
  const media = typeof summary.media === 'object' && summary.media !== null
    ? Number(summary.media.count || 0)
    : 0;
  const mediaPct = typeof summary.media === 'object' && summary.media !== null
    ? Number(summary.media.pct || 0).toFixed(2)
    : "0.00";
  
  const pct = (v)=> total ? (v/total*100).toFixed(2) : "0.00";

  // –¶–≤–µ—Ç–∞ –∏–∑ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  const css = getComputedStyle(document.documentElement);
  const COLOR_GRID        = (css.getPropertyValue('--border')     || '#E6E8EE').trim();
  const COLOR_GRID_STRONG = (css.getPropertyValue('--grid-strong')|| '#E6E8EE').trim();
  const COLOR_TEXT        = (css.getPropertyValue('--text-muted') || '#6B7280').trim();
  const COLOR_LINE        = (css.getPropertyValue('--brand-500')  || '#FF4F86').trim();
  const COLOR_RAYS        = (css.getPropertyValue('--brand-600')  || '#E83A73').trim();
  const COLOR_CENTER      = (css.getPropertyValue('--surface')    || '#FAFAFC').trim();
  const COLOR_PLOT_BG     = (css.getPropertyValue('--plot-bg')    || '#F4F5F7').trim();
  
  // ----- KPI -----
  const mediaBreakdown = summary.media_breakdown || {
    photo: {count: 0, pct: 0},
    gif: {count: 0, pct: 0},
    other: {count: 0, pct: 0}
  };
  const photoCount = Number(mediaBreakdown.photo?.count || 0);
  const photoPct = Number(mediaBreakdown.photo?.pct || 0).toFixed(2);
  const gifCount = Number(mediaBreakdown.gif?.count || 0);
  const gifPct = Number(mediaBreakdown.gif?.pct || 0).toFixed(2);
  const otherMediaCount = Number(mediaBreakdown.other?.count || 0);
  const otherMediaPct = Number(mediaBreakdown.other?.pct || 0).toFixed(2);
  
  const kpi = [
    ["–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π", total, null],
    ["–û—Ç–≤–µ—Ç–æ–≤", replies, repliesPct],
    ["–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö", edited, pct(edited)],
    ["–° —Ä–µ–∞–∫—Ü–∏—è–º–∏", react, reactPct],
    ["–ú–µ–¥–∏–∞", media, mediaPct],
    ["–§–æ—Ç–æ", photoCount, photoPct],
    ["–ì–∏—Ñ–∫–∏", gifCount, gifPct],
    ["–ò–Ω–æ–µ", otherMediaCount, otherMediaPct],
  ];
  const kpiRoot = document.getElementById('kpi');
  if (kpiRoot) {
    kpiRoot.innerHTML = kpi.map(([name,val,perc]) => `
      <div class="card">
        <div class="kpi">${Number(val).toLocaleString('ru-RU')}</div>
        <div class="muted">${name}${perc!==null ? ` <span class="pct">(${perc}%)</span>` : ""}</div>
      </div>`).join("");
    const note = document.createElement('div');
    note.className = 'muted';
    note.style.cssText = 'grid-column: 1 / -1; margin-top: 8px; font-size: 11px; line-height: 1.4;';
    note.textContent = '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ø—Ä–æ—Ü–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–µ–∞–∫—Ü–∏–π —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü—Ä–æ—Ü–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ç–æ, –≥–∏—Ñ–æ–∫ –∏ –∏–Ω–æ–≥–æ ‚Äî –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–µ–¥–∏–∞.';
    kpiRoot.appendChild(note);
  }
  
  // ----- helpers -----
  function drawAxes(ctx, W, H, margin){
    ctx.strokeStyle = COLOR_GRID; ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(margin, H-margin); ctx.lineTo(W-margin, H-margin);
    ctx.moveTo(margin, margin);   ctx.lineTo(margin, H-margin);
    ctx.stroke();
  }
  function scaleLinear(domainMin, domainMax, rangeMin, rangeMax){
    const span = (domainMax-domainMin) || 1;
    const k = (rangeMax-rangeMin)/span;
    return (x)=> rangeMin + (x-domainMin)*k;
  }
  function niceMax(v){
    if (v <= 0) return 1;
    const p = Math.pow(10, Math.floor(Math.log10(v)));
    return Math.ceil(v/p)*p;
  }

  // ----- Line Chart (daily) -----
  (function(){
    const c = document.getElementById('daily');
    if (!c) return;
    const labels = Object.keys(daily).sort();
    const values = labels.map(d => daily[d]);
    const ctx = c.getContext('2d');
    const W = c.width = c.clientWidth * devicePixelRatio;
    const H = c.height = c.clientHeight * devicePixelRatio;
    const m = 50;
    ctx.fillStyle = COLOR_PLOT_BG;
    ctx.fillRect(m, m, W - 2*m, H - 2*m);
    const maxY = niceMax(values.reduce((a,b)=>Math.max(a,b), 0));
    const sx = scaleLinear(0, Math.max(labels.length-1,1), m, W-m);
    const sy = scaleLinear(0, maxY, H-m, m);
    ctx.strokeStyle = COLOR_GRID_STRONG; ctx.lineWidth = 1;
    const gridLines = 5;
    for (let i=1;i<=gridLines;i++){
      const y = sy(maxY*i/gridLines);
      ctx.beginPath(); ctx.moveTo(m, y); ctx.lineTo(W-m, y); ctx.stroke();
    }
    drawAxes(ctx, W, H, m);
    ctx.strokeStyle = COLOR_LINE; ctx.lineWidth = 2;
    ctx.beginPath();
    labels.forEach((_, i) => {
      const x = sx(i), y = sy(values[i]);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    ctx.fillStyle = COLOR_TEXT; ctx.font = (12*devicePixelRatio)+"px system-ui";
    const step = Math.ceil(labels.length/8);
    labels.forEach((lab, i) => {
      if (i % step !== 0 && i !== labels.length-1) return;
      const x = sx(i);
      ctx.fillText(lab, x-20, H - m + 18*devicePixelRatio);
    });
  })();

  // ----- Clockface (hourly) -----
  (function(){
    const c = document.getElementById('hourly');
    if (!c) return;
    const labels = Array.from({length:24}, (_,h)=>String(h));
    const values = labels.map(h => Number(hourly[h]||0));
    const DPR = devicePixelRatio || 1;
    const W = c.width  = c.clientWidth  * DPR;
    const H = c.height = c.clientHeight * DPR;
    const ctx = c.getContext('2d');
    const cx = W/2, cy = H/2;
    const Rmin = Math.min(W,H) * 0.22;
    const Rmax = Math.min(W,H) * 0.46;
    const step = (Math.PI*2) / 24;
    const start = -Math.PI/2;
    const maxV = Math.max(1, values.reduce((a,b)=>Math.max(a,b), 0));
    ctx.strokeStyle = COLOR_GRID;
    ctx.lineWidth = 1;
    for (let i=1;i<=4;i++){
      const r = Rmin + (Rmax-Rmin) * (i/4);
      ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.stroke();
    }
    ctx.strokeStyle = COLOR_GRID;
    ctx.fillStyle   = COLOR_TEXT;
    ctx.lineWidth = 1;
    ctx.font = (12*DPR)+"px system-ui";
    for (let h=0; h<24; h++){
      const a = start + h*step;
      const rTick0 = Rmax + 6*DPR;
      const rTick1 = Rmax + (h%6===0 ? 16*DPR : 12*DPR);
      const x0 = cx + Math.cos(a)*rTick0, y0 = cy + Math.sin(a)*rTick0;
      const x1 = cx + Math.cos(a)*rTick1, y1 = cy + Math.sin(a)*rTick1;
      ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.stroke();
      const rLbl = Rmax + 24*DPR;
      const xl = cx + Math.cos(a)*rLbl, yl = cy + Math.sin(a)*rLbl + 4*DPR;
      const txt = String(h).padStart(2,"0");
      ctx.fillText(txt, xl - 10*DPR, yl);
    }
    ctx.strokeStyle = COLOR_RAYS;
    ctx.lineWidth = Math.max(4*DPR, Math.min(W,H)*0.02);
    ctx.lineCap = "round";
    for (let h=0; h<24; h++){
      const v = values[h];
      const a = start + h*step;
      const r = Rmin + (Rmax - Rmin) * (v / maxV);
      const x0 = cx + Math.cos(a)*Rmin, y0 = cy + Math.sin(a)*Rmin;
      const x1 = cx + Math.cos(a)*r,    y1 = cy + Math.sin(a)*r;
      ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.stroke();
    }
    ctx.fillStyle = COLOR_CENTER;
    ctx.beginPath(); ctx.arc(cx, cy, Rmin-6*DPR, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = COLOR_TEXT;
    ctx.font = (11*DPR)+"px system-ui";
    ctx.fillText("max: " + maxV.toLocaleString('ru-RU'), cx - 28*DPR, cy + 4*DPR);
  })();
  
  // ----- Top Authors (top-10) -----
  (function(){
    const tbody = document.querySelector('#topAuthors tbody');
    if (!tbody) return;
    tbody.innerHTML = (top || []).slice(0,10).map((row, idx) => {
      let username = row.username || row.from_id || "";
      let count = row.count || 0;
      return `<tr><td>${idx+1}</td><td>${username}</td><td>${count} <span class="pct">(${pct(count)}%)</span></td></tr>`;
    }).join("");
  })();
  
  // ----- Threads (top-5) -----
  (function(){
    const rows = data.threads_top5 || [];
    const tb = document.querySelector('#tblThreads tbody');
    if (!tb) return;
    tb.innerHTML = rows.map((r, i) => `
      <tr>
        <td>${i+1}</td>
        <td>${r.root_id ?? ""}</td>
        <td>${r.username ?? ""}</td>
        <td>${r.size ?? 0}</td>
        <td>${r.unique_participants ?? 0}</td>
        <td>${r.date_norm ?? ""}</td>
      </tr>`).join("");
  })();

  // ----- Emoji (top-5) -----
  (function(){
    const rows = data.emoji_top5 || [];
    const tb = document.querySelector('#tblEmoji tbody');
    if (!tb) return;
    tb.innerHTML = rows.map((r, i) => `
      <tr><td>${i+1}</td><td>${r.emoji ?? ""}</td><td>${r.count ?? 0}</td></tr>`
    ).join("");
  })();
  
  // ----- Most reacted messages (top-3) -----
  (function(){
    const rows = data.top_reacted_messages_top3 || [];
    const tb = document.querySelector('#tblRMsgs tbody');
    if (!tb) return;
    tb.innerHTML = rows.map((r, i) => `
      <tr>
        <td>${i+1}</td>
        <td>${r.username ?? ""}</td>
        <td>${r.reactions_total ?? 0}</td>
        <td>${r.date_norm ?? ""}</td>
        <td>${(r.text_preview || "").replace(/</g,"&lt;")}</td>
      </tr>`).join("");
  })();

  // ----- Reactions by author (top-5) -----
  (function(){
    const rows = data.reactions_by_author_top5 || [];
    const tb = document.querySelector('#tblRUsers tbody');
    if (!tb) return;
    tb.innerHTML = rows.map((r, i) => `
      <tr><td>${i+1}</td><td>${r.username ?? ""}</td><td>${r.total_reactions ?? 0}</td></tr>`
    ).join("");
  })();
  
  // ----- Media shares -----
  (function(){
    const flags = data.media_shares || {};
    const tb = document.querySelector('#tblMedia tbody');
    if (!tb) return;
    const items = Object.entries(flags)
      .map(([k, v]) => ({
        key: k,
        count: v.count ?? 0,
        pct: typeof v.pct === "number" ? v.pct.toFixed(2) : (v.pct || "0.00")
      }))
      .sort((a, b) => b.count - a.count);
    tb.innerHTML = items.map(item => 
      `<tr><td>${item.key}</td><td>${item.count}</td><td>${item.pct}%</td></tr>`
    ).join("");
  })();
  
  // ----- Poll creators (top-3) -----
  (function(){
    const rows = data.poll_creators_top3 || [];
    const tb = document.querySelector('#tblPolls tbody');
    if (!tb) return;
    tb.innerHTML = rows.map((r, i) => `
      <tr><td>${i+1}</td><td>${r.username ?? ""}</td><td>${r.polls ?? 0}</td></tr>`
    ).join("");
  })();
  
  // ----- –°–æ—Ü–∏–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ -----
  const social = data.social_graph || {};
  
  // –ò–Ω–¥–µ–∫—Å —Ü–∏—Ç–∏—Ä—É–µ–º–æ—Å—Ç–∏
  (function(){
    const rows = social.quotability_index?.top_quoted || [];
    const tb = document.querySelector('#tblQuotability tbody');
    if (!tb) return;
    if (rows.length === 0) {
      tb.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }
    tb.innerHTML = rows.map((r, i) => `
      <tr><td>${i+1}</td><td>${r.username ?? ""}</td><td>${r.replies_received ?? 0}</td></tr>`
    ).join("");
  })();
  
  // –ú–∞—Ç—Ä–∏—Ü–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
  (function(){
    const rows = social.mention_matrix?.top_mentioned || [];
    const tb = document.querySelector('#tblMentions tbody');
    if (!tb) return;
    if (rows.length === 0) {
      tb.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }
    tb.innerHTML = rows.map((r, i) => `
      <tr><td>${i+1}</td><td>${r.username ?? ""}</td><td>${r.count ?? 0}</td></tr>`
    ).join("");
  })();
  
  // –ö–∞—Ä—Ç–∞ —Å–∏–º–ø–∞—Ç–∏–π
  (function(){
    const rows = social.reply_matrix?.top_pairs || [];
    const tb = document.querySelector('#tblReplyMatrix tbody');
    if (!tb) return;
    if (rows.length === 0) {
      tb.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }
    tb.innerHTML = rows.map((r, i) => `
      <tr><td>${i+1}</td><td>${r.from_username ?? ""}</td><td>${r.to_username ?? ""}</td><td>${r.count ?? 0}</td></tr>`
    ).join("");
  })();
  
  // –õ—é–±–∏—Ç–µ–ª–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö
  (function(){
    const rows = social.voice_lovers?.top_users || [];
    const tb = document.querySelector('#tblVoiceLovers tbody');
    if (!tb) return;
    if (rows.length === 0) {
      tb.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }
    tb.innerHTML = rows.map((r, i) => `
      <tr><td>${i+1}</td><td>${r.username ?? ""}</td><td>${r.total_hours ?? 0}</td><td>${r.total_seconds ?? 0}</td></tr>`
    ).join("");
  })();
  
  // –í–Ω–µ—à–Ω–∏–µ —Å—Å—ã–ª–∫–∏
  (function(){
    const rows = social.external_links?.top_domains || [];
    const tb = document.querySelector('#tblDomains tbody');
    if (!tb) return;
    if (rows.length === 0) {
      tb.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }
    tb.innerHTML = rows.map((r, i) => `
      <tr><td>${i+1}</td><td>${r.domain ?? ""}</td><td>${r.count ?? 0}</td></tr>`
    ).join("");
  })();
  
  // –ö—Ä–∏–∫—É–Ω—ã
  (function(){
    const rows = social.caps_screamers?.top_users || [];
    const tb = document.querySelector('#tblCapsScreamers tbody');
    if (!tb) return;
    if (rows.length === 0) {
      tb.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }
    tb.innerHTML = rows.map((r, i) => `
      <tr><td>${i+1}</td><td>${r.username ?? ""}</td><td>${r.caps_messages ?? 0}</td><td>${r.caps_percentage ?? 0}%</td></tr>`
    ).join("");
  })();
  
  // –û—Ñ–æ—Ä–º–∏—Ç–µ–ª–∏
  (function(){
    const rows = social.formatting_stylists?.top_users || [];
    const tb = document.querySelector('#tblFormatting tbody');
    if (!tb) return;
    if (rows.length === 0) {
      tb.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }
    tb.innerHTML = rows.map((r, i) => {
      const breakdown = r.breakdown || {};
      const details = Object.entries(breakdown)
        .map(([k, v]) => `${k}: ${v}`)
        .join(', ');
      return `<tr><td>${i+1}</td><td>${r.username ?? ""}</td><td>${r.total_formatting ?? 0}</td><td style="font-size:11px;">${details}</td></tr>`;
    }).join("");
  })();
  
  // –°–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å
  (function(){
    const rows = social.vocabulary_diversity?.top_users || [];
    const tb = document.querySelector('#tblVocabulary tbody');
    if (!tb) return;
    if (rows.length === 0) {
      tb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }
    tb.innerHTML = rows.map((r, i) => `
      <tr><td>${i+1}</td><td>${r.username ?? ""}</td><td>${r.total_words ?? 0}</td><td>${r.total_messages ?? 0}</td><td>${r.mattr_score ?? 0}%</td></tr>`
    ).join("");
  })();
  
  // –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏
  (function(){
    const rows = social.reaction_speed?.top_users || [];
    const tb = document.querySelector('#tblReactionSpeed tbody');
    if (!tb) return;
    if (rows.length === 0) {
      tb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }
    tb.innerHTML = rows.map((r, i) => {
      const medianSec = r.median_seconds ?? 0;
      const medianMin = r.median_minutes ?? 0;
      const medianHours = r.median_hours ?? 0;
      let timeStr = '';
      if (medianHours >= 1) {
        timeStr = `${medianHours} —á`;
      } else if (medianMin >= 1) {
        timeStr = `${medianMin} –º–∏–Ω`;
      } else {
        timeStr = `${medianSec} —Å–µ–∫`;
      }
      return `<tr><td>${i+1}</td><td>${r.username ?? ""}</td><td>${timeStr}</td><td>${r.total_replies ?? 0}</td><td>${r.total_messages ?? 0}</td></tr>`;
    }).join("");
  })();
  
  // –°–æ–≤—ã vs –ñ–∞–≤–æ—Ä–æ–Ω–∫–∏
  (function(){
    const rows = social.owls_vs_larks?.users || [];
    const tb = document.querySelector('#tblOwlsVsLarks tbody');
    if (!tb) return;
    if (rows.length === 0) {
      tb.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }
    const displayRows = rows.slice(0, 15);
    tb.innerHTML = displayRows.map((r, i) => {
      const categoryEmoji = r.category === "–°–æ–≤–∞" ? "ü¶â" : r.category === "–ñ–∞–≤–æ—Ä–æ–Ω–æ–∫" ? "üê¶" : "üòê";
      return `<tr><td>${i+1}</td><td>${r.username ?? ""}</td><td>${categoryEmoji} ${r.category ?? ""}</td><td>${r.night_percentage ?? 0}%</td><td>${r.day_percentage ?? 0}%</td><td>${r.total_messages ?? 0}</td></tr>`;
    }).join("");
  })();
  
  // –°–∞–º–æ—Ü–µ–Ω–∑—É—Ä–∞
  (function(){
    const rows = social.self_censorship?.top_users || [];
    const tb = document.querySelector('#tblSelfCensorship tbody');
    if (!tb) return;
    if (rows.length === 0) {
      tb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }
    tb.innerHTML = rows.map((r, i) => `
      <tr><td>${i+1}</td><td>${r.username ?? ""}</td><td>${r.edited_messages ?? 0}</td><td>${r.total_messages ?? 0}</td><td>${r.edit_percentage ?? 0}%</td></tr>`
    ).join("");
  })();
  
})();
</script>
</body>
</html>